#!/bin/bash
#MISE description="Check if background dev mode is running (shows PID, watchers, and useful commands)"
set -Eeuo pipefail

# Script: dev-status
# Purpose: Check if background development mode is running
# Usage: mise dev-status

# Get script directory for consistent paths
SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd -P)"
PROJECT_ROOT="$(cd -- "$SCRIPT_DIR/.." && pwd -P)"

# Configuration
readonly PIDFILE="${PROJECT_ROOT}/.mise-dev.pid"
readonly LOGFILE="${PROJECT_ROOT}/.mise-dev.log"

# Check if process is running
is_process_running() {
    local -r pid="$1"
    kill -0 "$pid" 2>/dev/null
}

# Check and report status
check_status() {
    if [[ ! -f "$PIDFILE" ]]; then
        echo "‚ö´ Dev mode is not running"
        echo ""
        echo "Start with:"
        echo "  mise dev        # Foreground mode (bacon)"
        echo "  mise dev --bg   # Background mode (multiple watchers)"
        return 0
    fi

    local pid
    pid=$(cat "$PIDFILE")

    if is_process_running "$pid"; then
        echo "‚úÖ Dev mode is running in background (PID: $pid)"
        echo ""
        echo "Watchers active:"
        echo "  ‚Ä¢ build watcher"
        echo "  ‚Ä¢ test watcher"
        echo "  ‚Ä¢ check watcher"
        echo "  ‚Ä¢ lint watcher"
        echo "  ‚Ä¢ doc watcher"
        echo ""
        echo "Commands:"
        echo "  üìù Logs:   mise dev-logs"
        echo "  üõë Stop:   mise dev-stop"
        return 0
    else
        echo "‚ùå Dev mode is not running (stale PID file)"
        rm -f "$PIDFILE"
        return 1
    fi
}

# Main execution
main() {
    check_status
}

main "$@"
