[tools]
rust = "latest"
"cargo:bacon" = "latest"
"cargo:cargo-audit" = "latest"
"cargo:cargo-outdated" = "latest"
"cargo:cargo-watch" = "latest"

[env]
APP_PROFILE = "debug"
RUST_BACKTRACE = "full"
RUST_LOG = "debug"

[tasks.check]
description = "Run quick checks (no codegen)"
run = "cargo check --all-targets"

[tasks.lint]
description = "Run clippy and fix warnings automatically"
run = "cargo clippy --fix --allow-dirty --allow-staged"

[tasks.lint-check]
description = "Run clippy linter without fixing"
run = "cargo clippy --all-targets -- -D warnings"

[tasks.fmt]
description = "Format code"
run = "cargo fmt"

[tasks.fmt-check]
description = "Check formatting without modifying files"
run = "cargo fmt -- --check"

[tasks.test]
description = "Run tests"
run = "cargo test"

[tasks.test-verbose]
description = "Run tests with output"
run = "cargo test -- --nocapture"

[tasks.health-check]
description = "Run application health checks"
run = "cargo build --bin game && ./target/debug/game --health-check"

[tasks.build]
description = "Build in debug mode"
run = "cargo build"

[tasks.run-debug]
description = "Build and run in debug mode"
run = "cargo build && ./target/debug/game"

[tasks.release]
description = "Build in release mode"
run = "cargo build --release"

[tasks.run-release]
description = "Build and run in release mode"
run = "cargo build --release && ./target/release/game"

[tasks.clean]
description = "Clean build artifacts"
run = "cargo clean"

[tasks.ci]
description = "Run all CI checks locally"
depends = ["fmt-check", "lint-check", "test"]
run = "echo '‚úÖ All CI checks passed!'"

[tasks.watch]
description = "Watch and run both tests and clippy"
run = "bacon"

[tasks.watch-all]
description = "Watch and run multiple tasks in parallel (build, test, check, lint) in background"
run = """
LOGFILE=".mise-watch-all.log"
PIDFILE=".mise-watch-all.pid"

# Check if already running
if [ -f "$PIDFILE" ] && kill -0 $(cat "$PIDFILE") 2>/dev/null; then
  echo "‚ùå watch-all is already running (PID: $(cat $PIDFILE))"
  echo "Run 'mise watch-all-stop' to stop it first"
  exit 1
fi

# Start background process
nohup bash -c '
  trap "kill 0" EXIT
  mise watch build &
  mise watch test &
  mise watch check &
  mise watch lint-check &
  wait
' > "$LOGFILE" 2>&1 &

echo $! > "$PIDFILE"
echo "‚úÖ watch-all started in background (PID: $(cat $PIDFILE))"
echo "üìù Logs: tail -f $LOGFILE"
echo "üõë Stop: mise watch-all-stop"
"""

[tasks.watch-all-stop]
description = "Stop the background watch-all task"
run = """
PIDFILE=".mise-watch-all.pid"

if [ ! -f "$PIDFILE" ]; then
  echo "‚ùå watch-all is not running (no PID file found)"
  exit 1
fi

PID=$(cat "$PIDFILE")
if ! kill -0 "$PID" 2>/dev/null; then
  echo "‚ùå watch-all is not running (stale PID file)"
  rm "$PIDFILE"
  exit 1
fi

echo "Stopping watch-all (PID: $PID)..."
kill "$PID" 2>/dev/null
sleep 1

# Force kill if still running
if kill -0 "$PID" 2>/dev/null; then
  echo "Force killing..."
  kill -9 "$PID" 2>/dev/null
fi

rm "$PIDFILE"
echo "‚úÖ watch-all stopped"
"""

[tasks.watch-all-status]
description = "Check if watch-all is running"
run = """
PIDFILE=".mise-watch-all.pid"

if [ ! -f "$PIDFILE" ]; then
  echo "‚ö´ watch-all is not running"
  exit 0
fi

PID=$(cat "$PIDFILE")
if kill -0 "$PID" 2>/dev/null; then
  echo "‚úÖ watch-all is running (PID: $PID)"
  echo "üìù Logs: tail -f .mise-watch-all.log"
else
  echo "‚ùå watch-all is not running (stale PID file)"
  rm "$PIDFILE"
fi
"""

[tasks.watch-all-logs]
description = "Show watch-all logs"
run = "tail -f .mise-watch-all.log"

[tasks.doc]
description = "Generate and open documentation"
run = "cargo doc --no-deps --open"

[tasks.doc-watch]
description = "Watch and rebuild documentation on changes"
run = "cargo doc --no-deps"

[tasks.doc-deps]
description = "Build documentation for all dependencies"
run = "cargo doc --no-deps=false --document-private-items"

[tasks.doc-all]
description = "Build and open full documentation (including all deps)"
run = "cargo doc --document-private-items --open"

[tasks.setup-env]
description = "Setup project environment with full dependency docs cache"
run = "cargo doc --document-private-items && echo '‚úÖ Environment setup complete - all dependency docs cached in target/doc/'"

[tasks.update]
description = "Update dependencies"
run = "cargo update"

[tasks.outdated]
description = "Check for outdated dependencies (requires cargo-outdated)"
run = "cargo outdated"

[tasks.audit]
description = "Security audit (requires cargo-audit)"
run = "cargo audit"
